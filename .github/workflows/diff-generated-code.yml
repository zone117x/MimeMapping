name: Diff Generated Code

on:
  pull_request:

jobs:
  diff-generated:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          path: pr-branch

      - name: Checkout target branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          path: base-branch

      - name: Setup .NET
        uses: actions/setup-dotnet@baa11fbfe1d6520db94683bd5c7a3818018e4309 # v5
        with:
          dotnet-version: '10.0.x'

      - name: Build base branch to generate KnownMimeTypes.cs
        working-directory: base-branch
        run: dotnet build src/MimeMapping/MimeMapping.csproj

      - name: Build PR branch to generate KnownMimeTypes.cs
        working-directory: pr-branch
        run: dotnet build src/MimeMapping/MimeMapping.csproj

      - name: Generate diff
        id: diff
        run: |
          echo "=== DEBUG: Searching for generated files ==="
          echo "Base branch files:"
          find base-branch -name "KnownMimeTypes.cs" -o -name "KnownMimeTypes.g.cs" 2>/dev/null || echo "No files found"
          echo ""
          echo "PR branch files:"
          find pr-branch -name "KnownMimeTypes.cs" -o -name "KnownMimeTypes.g.cs" 2>/dev/null || echo "No files found"
          echo ""

          # Find the generated file (supports both old T4 and new source generator locations)
          BASE_FILE=$(find base-branch -name "KnownMimeTypes.cs" -o -name "KnownMimeTypes.g.cs" 2>/dev/null | head -1)
          PR_FILE=$(find pr-branch -name "KnownMimeTypes.cs" -o -name "KnownMimeTypes.g.cs" 2>/dev/null | head -1)

          echo "=== DEBUG: Selected files ==="
          echo "BASE_FILE: $BASE_FILE"
          echo "PR_FILE: $PR_FILE"
          echo ""

          if [ -z "$BASE_FILE" ] || [ -z "$PR_FILE" ]; then
            echo "ERROR: Could not find generated files!"
            echo "Listing all .cs files in obj directories:"
            find base-branch -path "*/obj/*" -name "*.cs" 2>/dev/null | head -20
            find pr-branch -path "*/obj/*" -name "*.cs" 2>/dev/null | head -20
            exit 1
          fi

          echo "=== DEBUG: File sizes ==="
          wc -l "$BASE_FILE" "$PR_FILE"
          echo ""

          # Extract only the public const string lines and diff them
          grep 'public const string .* = "' "$BASE_FILE" | sort > base-consts.txt
          grep 'public const string .* = "' "$PR_FILE" | sort > pr-consts.txt

          echo "=== DEBUG: Extracted constants count ==="
          wc -l base-consts.txt pr-consts.txt
          echo ""

          diff -u base-consts.txt pr-consts.txt > diff.txt || true

          if [ -s diff.txt ]; then
            echo "has_diff=true" >> $GITHUB_OUTPUT
            # Truncate if too large for GitHub comment (max ~65k chars)
            if [ $(wc -c < diff.txt) -gt 60000 ]; then
              head -c 60000 diff.txt > diff_truncated.txt
              echo -e "\n\n... (diff truncated, too large to display)" >> diff_truncated.txt
              mv diff_truncated.txt diff.txt
            fi
          else
            echo "has_diff=false" >> $GITHUB_OUTPUT
          fi

      - name: Post diff as PR comment
        if: steps.diff.outputs.has_diff == 'true'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const fs = require('fs');
            const diff = fs.readFileSync('diff.txt', 'utf8');

            const body = `## Generated Code Diff

            This PR changes the generated \`KnownMimeTypes.cs\` file:

            <details>
            <summary>Click to expand diff</summary>

            \`\`\`diff
            ${diff}
            \`\`\`

            </details>`;

            // Find existing comment to update
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('## Generated Code Diff')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }

      - name: Post no-diff comment
        if: steps.diff.outputs.has_diff == 'false'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const body = `## Generated Code Diff

            No changes to generated \`KnownMimeTypes.cs\` file.`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('## Generated Code Diff')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }
